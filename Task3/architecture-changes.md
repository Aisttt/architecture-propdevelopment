# Архитектурные изменения: Интеграция "Умный дом"

## Обзор изменений

Для интеграции сервисов "Умный дом" в существующую архитектуру PropDevelopment добавлены новые компоненты с фокусом на безопасность биометрических данных и IoT-устройств.

## I. Новые компоненты архитектуры

### 1. Housing Domain (расширен)

#### Новые микросервисы:

| Компонент | Технология | Назначение | Критичность |
|-----------|------------|------------|-------------|
| **Smart Home Integration** | Java, Spring Boot | Основной сервис интеграции с партнерской платформой | **Высокая** |
| **Biometric Consent Service** | Java, Spring Boot | Управление согласиями на обработку биометрии (152-ФЗ, ч.3) | **Критичная** |
| **Access Control Service** | Java, Spring Boot | Управление правами доступа к IoT-устройствам | **Высокая** |
| **IoT Device Management** | Java, Spring Boot | Мониторинг статуса и управление IoT-устройствами | **Средняя** |
| **Video Streaming Service** | Java, Spring Boot | Видеостриминг домофона (RTSP/TLS → WebRTC/SRTP) | **Высокая** |

#### Новые базы данных:

| БД | Тип | Содержимое | Шифрование |
|----|-----|------------|------------|
| **Smart Home DB** | PostgreSQL | Права доступа, логи устройств (БЕЗ биометрии) | **AES-256** |
| **Consent DB** | PostgreSQL | Согласия на обработку биометрических данных | **TDE** |

#### ВАЖНО: Хранение биометрии
- **Биометрические шаблоны** хранятся ТОЛЬКО в **Secure Element** IoT-устройств
- **НЕ в облаке**, **НЕ в Smart Home DB**, **НЕ у партнера**
- Передается только результат сравнения (да/нет)

### 2. API Gateway & Security (новый домен)

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| **Smart Home API Gateway** | Spring Cloud Gateway | Единая точка входа для партнерских API |
| **OAuth Authorization Server** | Spring Security OAuth | Выдача JWT токенов для партнеров |
| **Audit & Monitoring Service** | Java, Micrometer | Журналирование и мониторинг безопасности |

### 3. Измененные компоненты

| Компонент | Изменения | Цель |
|-----------|-----------|------|
| **Mobile App** | + Управление умным домом<br>+ Согласия на биометрию<br>+ Управление правами доступа<br>+ Видеозвонки с домофона | Единая точка управления для собственников |
| **Housing CRM** | + Интеграция с биометрическими согласиями<br>+ Привязка устройств к недвижимости | Централизация управления собственниками |

## II. Ключевые интеграции

### 2.1 Партнерская интеграция

```
PropDevelopment ↔ Партнерская платформа:
┌─────────────────────┐  OAuth 2.0 + mTLS  ┌──────────────────────┐
│  Smart Home API     │◄───────────────────│  Партнерская         │
│  Gateway            │                    │  платформа           │
│                     │  JWT + X.509 Cert  │                      │
│  Rate Limit: 1000/h│────────────────────▶│  Client Credentials  │
└─────────────────────┘                    └──────────────────────┘
         │ TLS 1.3
         ▼
┌─────────────────────┐
│ Video Streaming     │
│ Service             │
│ (RTSP→WebRTC)       │
└─────────────────────┘
```

### 2.2 Биометрическая безопасность

```
Обработка биометрии (152-ФЗ, ч.3):
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Мобильное      │    │  Biometric      │    │  Интеллектуал.  │
│  приложение     │    │  Consent Service│    │  домофон        │
│                 │    │                 │    │                 │
│ 1. Запрос       │───▶│ 2. Проверка     │    │ 4. Биошаблон    │
│    согласия     │    │    согласия     │    │ ТОЛЬКО В SECURE │
│                 │    │                 │    │ ELEMENT (AES)   │
│ 3. Подписание   │◄───│ Сохранение в    │    │ 5. Результат    │
│    ЭЦП          │    │ Consent DB      │    │    (да/нет)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘

КРИТИЧНО: Биошаблоны НЕ покидают устройство!
Smart Home DB содержит только: права доступа, логи, статусы
```

### 2.3 Видеостриминг

```
Безопасный видеостриминг:
┌─────────────────┐  RTSP/TLS   ┌──────────────────┐  WebRTC/SRTP  ┌─────────────────┐
│  Домофон        │──────────── ▶│  Video Streaming │──────────────▶│  Мобильное      │
│  + Камера       │             │  Service         │               │  приложение     │
│                 │             │                  │               │                 │
│ AES-128 шифр.   │◄─────────── │ - Media Relay    │◄─────────────│ SRTP дешифр.    │
│ H.264 кодек     │   Контроль  │ - Access Control │   Управление  │ Воспроизведение │
└─────────────────┘   сессии    │ - Session Mgmt   │   сессией     └─────────────────┘
                                └──────────────────┘

End-to-end шифрование: домофон → мобильное приложение
Временные сессии: максимум 5 минут на звонок
Все видеосессии логируются в Data Warehouse
```

## III. Безопасность архитектуры

### 3.1 Сетевая сегментация

| Зона | Компоненты | Уровень доступа | Протоколы |
|------|------------|-----------------|-----------|
| **DMZ** | API Gateway, WAF, Video Streaming | Интернет → DMZ | HTTPS/TLS 1.3 |
| **Private** | PropDevelopment сервисы | DMZ → Private | HTTPS/TLS 1.3 |
| **IoT** | Домофон, Шлагбаум | Private → IoT | MQTT/TLS 1.3 |

### 3.2 Поток данных

```
Поток данных (без передачи биометрии):
Internet ──TLS 1.3──▶ API Gateway ──JWT+mTLS──▶ Smart Home Service ──SQL──▶ Smart Home DB
    ▲                       │                          │                        │
    │                       ▼                          ▼                        ▼
Notifications ◄── OAuth Server ◄──── Access Control ◄──── Encrypted Storage
    ▲                       │
    │                       ▼
WebRTC/SRTP ◄── Video Streaming Service ◄──RTSP/TLS── Домофон (Secure Element)
```

### 3.3 Долгосрочное хранение аудит-логов

```
Архитектура аудита:
┌─────────────────────┐    ETL Pipeline    ┌──────────────────────┐
│  Audit & Monitoring │───────────────────▶│   Data Warehouse     │
│  Service            │                    │                      │
│                     │                    │  - Хранение ≥ 90д    │
│ - Реальное время    │                    │  - Сжатие логов      │
│ - Алерты < 1 мин    │                    │  - Индексы по ПДн    │
│ - Буферизация       │                    │  - Compliance отчеты │
└─────────────────────┘                    └──────────────────────┘
```

### 3.4 Compliance (152-ФЗ)

| Требование | Реализация | Статус |
|------------|------------|--------|
| **Письменное согласие** | Biometric Consent Service + ЭЦП | Выполнено |
| **Локальное хранение биометрии** | Secure Element в устройствах | Выполнено |
| **Аудит операций** | Audit & Monitoring Service → Data Warehouse | Выполнено |
| **Право на удаление** | API методы удаления биошаблонов | Выполнено |

## IV. Преимущества архитектуры

### 4.1 Безопасность
- **Принцип Zero Trust**: каждый запрос аутентифицируется
- **Defense in Depth**: многоуровневая защита (сеть + приложение + данные)
- **Fail Secure**: при сбоях доступ блокируется
- **Data Minimization**: биометрия не покидает устройства
- **End-to-end шифрование**: TLS 1.3 + mTLS + SRTP

### 4.2 Масштабируемость
- **Микросервисная архитектура**: независимое масштабирование компонентов
- **API Gateway**: централизованное управление трафиком
- **Горизонтальное масштабирование**: каждый сервис может масштабироваться отдельно
- **Media Relay**: распределенная обработка видео

### 4.3 Надежность
- **Circuit Breaker**: защита от каскадных сбоев
- **Rate Limiting**: защита от перегрузок
- **Health Checks**: мониторинг состояния компонентов
- **Graceful Degradation**: частичная работоспособность при сбоях
- **Видеосессии с таймаутом**: автоматическое завершение через 5 мин

## V. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| **Компрометация IoT-устройств** | Средняя | Высокое | Сетевая изоляция, Secure Element, TLS 1.3 |
| **Нарушение 152-ФЗ** | Низкая | Критическое | Локальное хранение биометрии, аудит |
| **Недоступность партнера** | Средняя | Среднее | Circuit Breaker, офлайн режим |
| **Атаки на API** | Высокая | Среднее | mTLS, Rate Limiting, WAF, мониторинг |
| **Перехват видеопотока** | Низкая | Высокое | End-to-end шифрование RTSP/TLS → WebRTC/SRTP |
| **Переполнение аудит-логов** | Средняя | Среднее | ETL в Data Warehouse, сжатие через 90 дней |

## VI. План развертывания

### Этап 1: Инфраструктура (4 недели)
1. Развертывание новых микросервисов (включая Video Streaming)
2. Настройка сетевой сегментации  
3. Внедрение API Gateway с mTLS
4. Интеграция Audit Service с Data Warehouse

### Этап 2: Интеграция (6 недель)
1. Разработка API для партнера с mTLS
2. Интеграция с мобильным приложением
3. Настройка видеостриминга (RTSP → WebRTC)
4. Тестирование безопасности

### Этап 3: Пилот (4 недели)
1. Установка устройств с Secure Element в тестовой локации
2. Получение согласий пользователей на биометрию
3. Тестирование видеозвонков
4. Мониторинг работы системы

### Этап 4: Production (8 недель)
1. Поэтапное развертывание по объектам
2. Обучение пользователей работе с видеозвонками
3. Непрерывный мониторинг аудит-логов
4. Compliance проверки по 152-ФЗ

## VII. Метрики успеха

| Метрика | Целевое значение | Критичность |
|---------|------------------|-------------|
| **Время отклика API** | < 200ms | Высокая |
| **Доступность системы** | 99.9% | Критическая |
| **Успешность биометрического распознавания** | > 95% | Высокая |
| **Качество видеосвязи** | < 150ms задержка, HD качество | Высокая |
| **Количество инцидентов безопасности** | 0 | Критическая |
| **Соответствие 152-ФЗ** | 100% | Критическая |
| **Время хранения аудит-логов** | ≥ 90 дней в Data Warehouse | Средняя | 