# Task3 - Внешние интеграции «Умный дом»

## Цель
Спроектировать безопасную архитектуру интеграции новых сервисов "Умный дом" от партнера с существующей системой PropDevelopment.

## Новые бизнес-функции

### 1. Интеллектуальный домофон
- **Классические функции**: видеодомофон, открытие по звонку
- **Умные функции**: распознавание по биометрии (лицо), автоматическое открытие
- **Особенности безопасности**: обработка биометрических данных (152-ФЗ, ч.3)

### 2. Интеллектуальный шлагбаум  
- **Классические функции**: управление шлагбаумом
- **Умные функции**: распознавание номеров автомобилей, автоматический въезд
- **Особенности безопасности**: обработка данных о перемещениях

## Технические требования

### Интеграция
- Сервисы предоставляет **внешний партнер**
- Доступ через **существующее мобильное приложение** собственников
- Интеграция с Housing Domain (tenant-core-app, CRM)

### Безопасность (критично)
- **Биометрия** - особая категория ПДн по 152-ФЗ, требует усиленной защиты
- **IoT-устройства** - новые векторы атак, требуют сегментации
- **Автоматический доступ** - критически важная функция безопасности
- **Партнерская интеграция** - внешние системы, риски межтенантных утечек

## Выполненная работа

### 1. Диаграмма контекста C4
- Определены основные акторы: собственники, жильцы, гости, УК
- Показаны внешние системы: партнерская платформа, IoT-устройства
- Отражены ключевые взаимодействия через мобильное приложение
- Указаны протоколы безопасности TLS 1.3/mTLS для всех внешних соединений

### 2. Диаграмма контейнеров
- Расширен Housing Domain новыми микросервисами для умного дома
- Добавлен новый домен "API Gateway & Security" 
- Интегрированы компоненты для обработки биометрии по 152-ФЗ
- Включен Video Streaming Service для видеозвонков через домофон

### 3. Требования безопасности
- Детализированы протоколы аутентификации и авторизации
- Определена архитектура сетевой безопасности с сегментацией
- Проработаны требования соответствия 152-ФЗ для биометрии
- Описаны процессы видеостриминга и долгосрочного хранения аудит-логов

## Результаты

| Файл | Описание |
|------|----------|
| **[context-diagram.puml](./context-diagram.puml)** | Диаграмма контекста C4 для "Умного дома" (PlantUML) |
| **[context-diagram.png](./context-diagram.png)** | Диаграмма контекста C4 (PNG для просмотра) |
| **[container-diagram-updated.puml](./container-diagram-updated.puml)** | Обновленная диаграмма контейнеров PropDevelopment (PlantUML) |
| **[container-diagram-updated.png](./container-diagram-updated.png)** | Обновленная диаграмма контейнеров (PNG для просмотра) |
| **[security-requirements.md](./security-requirements.md)** | Детальные требования безопасности и протоколы интеграции |
| **[architecture-changes.md](./architecture-changes.md)** | Описание архитектурных изменений и новых компонентов |

## Ключевые архитектурные решения

### Новые микросервисы в Housing Domain:
- **Smart Home Integration** - основной сервис интеграции
- **Biometric Consent Service** - управление согласиями по 152-ФЗ  
- **Access Control Service** - управление правами доступа
- **IoT Device Management** - мониторинг устройств
- **Video Streaming Service** - безопасный видеостриминг

### Безопасность биометрии:
- **Локальное хранение** биошаблонов в устройствах (Secure Element)
- **Запрет передачи** сырых биометрических данных
- **Письменное согласие** через мобильное приложение с ЭЦП
- **Полный аудит** всех операций с биометрией

### Партнерская интеграция:
- **OAuth 2.0 + mTLS** для авторизации партнерской системы
- **API Gateway** как единая точка входа
- **Rate Limiting** и **Circuit Breaker** для надежности
- **JWT токены** с ограниченным временем жизни

### Видеобезопасность:
- **RTSP/TLS** для захвата видео с домофона
- **WebRTC/SRTP** для передачи в мобильное приложение
- **Media Relay** с Access Control
- **Аудит всех видеосессий**

## Соответствие 152-ФЗ

| Требование 152-ФЗ | Техническая реализация | Статус |
|-------------------|----------------------|---------|
| **ч.3: Письменное согласие на биометрию** | Biometric Consent Service + ЭЦП | Выполнено |
| **ст.11: Меры безопасности** | Шифрование, сегментация, аудит | Выполнено |
| **ст.16: Обработка только с согласия** | Проверка согласия перед операциями | Выполнено |
| **ст.18: Уведомление об обработке** | Пользовательские соглашения | Выполнено |

## Протоколы безопасности

### Аутентификация:
- **Собственники**: OpenID Connect (логин/пароль + SMS 2FA)
- **Жильцы**: OAuth 2.0 (биометрия + PIN код)  
- **Партнер**: OAuth 2.0 Client Credentials + mTLS
- **IoT устройства**: Mutual TLS + сертификаты

### Сетевая архитектура:
- **DMZ зона**: API Gateway, WAF, Video Streaming Service
- **Private зона**: PropDevelopment сервисы
- **IoT зона**: Изолированные устройства (односторонняя связь)

## Ключевые вызовы безопасности

- **152-ФЗ compliance** для биометрических данных
- **IoT Security** - защита умных устройств от компрометации
- **Partner API Security** - безопасная интеграция с внешней платформой
- **Access Control** - управление автоматическим доступом  
- **Network Segmentation** - изоляция IoT-устройств
- **Data Minimization** - минимизация обработки биометрии
- **Video Security** - защита видеопотоков end-to-end

## План развертывания

| Этап | Длительность | Ключевые задачи |
|------|-------------|-----------------|
| **Подготовка** | 2-3 недели | Политики безопасности, сетевая сегментация |
| **Интеграция** | 4-6 недель | OAuth 2.0 + mTLS, API разработка, Video Streaming, тестирование |
| **Пилот** | 2-4 недели | Тестовая установка, согласия пользователей, видеозвонки |
| **Production** | 8-12 недель | Массовое развертывание, мониторинг, аудит |

## Метрики успеха

- **Доступность системы**: 99.9%
- **Время отклика API**: < 200ms  
- **Успешность биометрического распознавания**: > 95%
- **Качество видеосвязи**: < 150ms задержка, HD качество
- **Инциденты безопасности**: 0
- **Соответствие 152-ФЗ**: 100%
- **Долгосрочное хранение аудит-логов**: минимум 90 дней 