# Требования безопасности: Интеграция "Умный дом"

**Критично**: Система обрабатывает биометрические данные (152-ФЗ, ч.3) и управляет физическим доступом к недвижимости

## I. Общие требования безопасности

### 1.1 Принципы архитектуры безопасности

| Принцип | Описание | Реализация |
|---------|----------|------------|
| **Zero Trust** | Никому не доверять, всегда проверять | Аутентификация каждого запроса, микросегментация сети |
| **Defense in Depth** | Многоуровневая защита | Шифрование + аутентификация + авторизация + аудит |
| **Fail Secure** | Безопасное поведение при сбоях | При отказе системы - доступ заблокирован, уведомления владельцу |
| **Principle of Least Privilege** | Минимальные необходимые права | Партнер получает доступ только к необходимым API endpoint'ам |
| **Data Minimization** | Минимизация обработки данных | Биометрические шаблоны не покидают устройства |

### 1.2 Классификация данных

| Категория | Типы данных | Уровень защиты | 152-ФЗ |
|-----------|-------------|----------------|---------|
| **СЕКРЕТНЫЕ** | Биометрические шаблоны лиц | Максимальный | ч.3 |
| **КОНФИДЕНЦИАЛЬНЫЕ** | ПДн собственников/жильцов | Высокий | ч.1 |
| **КОНФИДЕНЦИАЛЬНЫЕ** | Данные о перемещениях (номера авто) | Высокий | ч.1 |  
| **КОНФИДЕНЦИАЛЬНЫЕ** | Видеопотоки домофонов | Высокий | ч.1 |
| **ВНУТРЕННИЕ** | Журналы доступа без ПДн | Средний | - |
| **ПУБЛИЧНЫЕ** | Статус устройств (онлайн/офлайн) | Низкий | - |

## II. Биометрическая безопасность (152-ФЗ, ч.3)

### 2.1 Требования к обработке биометрии

**КРИТИЧНО**: Биометрические данные - особая категория ПДн, требующая письменного согласия субъекта

| Требование | Описание | Техническая реализация |
|------------|----------|----------------------|
| **Локальное хранение** | Биошаблоны ТОЛЬКО в устройстве | **Secure Element в домофоне, AES-256, НЕ в облаке** |
| **Запрет передачи** | Биометрия не покидает устройство | Только результат сравнения (да/нет) |
| **Письменное согласие** | Согласие на обработку биометрии | Форма в мобильном приложении с ЭЦП |
| **Право на удаление** | Возможность удалить биошаблон | API метод для удаления из устройства |
| **Аудит обработки** | Журналирование всех операций | Лог попыток распознавания + SIEM |

### 2.2 Технические меры защиты биометрии

```
Архитектура защиты биометрии:
┌─────────────────────┐    ┌──────────────────────┐    ┌─────────────────────┐
│   Мобильное         │    │  Партнерская         │    │  Интеллектуальный   │
│   приложение        │    │  платформа           │    │  домофон            │
│                     │    │                      │    │                     │
│ - Регистрация лица  │───▶│ - API управления     │───▶│ - Secure Element    │
│ - Управление правами│    │ - Синхронизация прав │    │ - Биошаблоны (AES)  │
│ - Получение согласия│    │ - Аудит операций     │    │ - Локальное сравнение│
└─────────────────────┘    └──────────────────────┘    └─────────────────────┘
         ▲                           ▲                           │
         │                           │                           │
         └───── Уведомления ◄────────┴──── Результат (да/нет) ◄───┘
              (не биометрия!)              (не биометрия!)

ВАЖНО: Биометрические шаблоны НЕ хранятся в Smart Home DB!
В БД хранятся только: права доступа, логи событий, статусы устройств
```

## III. Видеостриминг и мультимедиа безопасность

### 3.1 Архитектура видеостриминга

| Компонент | Протокол | Шифрование | Назначение |
|-----------|----------|------------|------------|
| **Домофон → Video Service** | RTSP/TLS | AES-128 | Захват видео с устройства |
| **Video Service → Mobile App** | WebRTC | SRTP (AES-256) | Передача видео пользователю |
| **Signaling** | WebSocket/TLS 1.3 | TLS | Установка видеосессии |
| **Media Relay** | TURN/TLS | DTLS-SRTP | Ретрансляция через NAT |

### 3.2 Безопасность видеопотоков

```
Безопасный видеостриминг:
┌─────────────────┐  RTSP/TLS   ┌──────────────────┐  WebRTC/SRTP  ┌─────────────────┐
│  Домофон        │──────────── ▶│  Video Streaming │──────────────▶│  Мобильное      │
│  + Камера       │             │  Service         │               │  приложение     │
│                 │             │                  │               │                 │
│ AES-128 шифр.   │◄─────────── │ - Media Relay    │◄─────────────│ SRTP дешифр.    │
│ H.264 кодек     │   Контроль  │ - Access Control │   Управление  │ Воспроизведение │
└─────────────────┘   сессии    │ - Session Mgmt   │   сессией     └─────────────────┘
                                └──────────────────┘

Шифрование end-to-end: домофон → мобильное приложение
Временные сессии: максимум 5 минут на звонок
Аудит всех видеосессий в Data Warehouse
```

## IV. Протоколы аутентификации и авторизации

### 4.1 Аутентификация пользователей

| Участник | Протокол | Метод | Срок действия |
|----------|----------|--------|---------------|
| **Собственники** | OpenID Connect | Логин/пароль + SMS 2FA | 24 часа |
| **Жильцы** | OAuth 2.0 | Биометрия + PIN код | 12 часов |
| **Гости** | Временные токены | QR-код от собственника | 1-24 часа |
| **УК** | SAML 2.0 | Корпоративная аутентификация | 8 часов |

### 4.2 Авторизация системных интеграций

**Партнерская система ↔ PropDevelopment:**

```
OAuth 2.0 Client Credentials Flow + mTLS:
┌─────────────────┐     ┌─────────────────────┐     ┌──────────────────────┐
│  Партнерская    │  1. │   PropDevelopment   │  4. │    Разрешенные       │
│  система        │────▶│   Authorization     │────▶│    API endpoints     │
│                 │     │   Server            │     │                      │
│ Client ID       │◄─ 2.│   + mTLS Cert       │     │ GET /access-rights   │
│ Client Secret   │     │   Verification      │     │ POST /access-logs    │
│ X.509 Cert      │  3. │ Выдача Access Token │     │ PUT /device-status   │
└─────────────────┘     └─────────────────────┘     └──────────────────────┘

JWT Token содержит:
- iss: "propdevelopment.com"
- aud: "smart-home-partner"  
- scope: "device:read device:control access:log video:stream"
- exp: 3600 (1 час)
- cert_fingerprint: SHA-256 отпечаток клиентского сертификата
```

### 4.3 API Security для партнерской интеграции

| Endpoint | Метод | Авторизация | Rate Limit | Назначение |
|----------|--------|-------------|------------|------------|
| `/api/v1/access-rights/{deviceId}` | GET | Bearer + mTLS | 100/min | Получение прав доступа |
| `/api/v1/access-rights/{deviceId}` | PUT | Bearer + mTLS | 10/min | Обновление прав доступа |
| `/api/v1/access-logs` | POST | Bearer + mTLS | 1000/min | Отправка логов доступа |
| `/api/v1/devices/{deviceId}/status` | PUT | Bearer + mTLS | 60/min | Статус устройства |
| `/api/v1/video/sessions` | POST | Bearer + mTLS | 30/min | Создание видеосессии |
| `/api/v1/notifications` | POST | Bearer + mTLS | 100/min | Уведомления пользователям |

**Обязательные заголовки безопасности:**
```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
X-API-Version: v1
X-Request-ID: <UUID>
X-Timestamp: <ISO8601>
X-Signature: <HMAC-SHA256(payload + timestamp + secret)>
X-Client-Cert-Fingerprint: <SHA-256>
```

## V. Сетевая безопасность и архитектура

### 5.1 Сегментация сети

```
Архитектура сетевой безопасности:
┌─────────────────────────────────────────────────────────────────────────────┐
│                          INTERNET                                           │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ TLS 1.3
┌─────────────────────────▼───────────────────────────────────────────────────┐
│                     DMZ ZONE                                               │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐  │
│  │   WAF/DDOS      │    │   API Gateway   │    │  Video Streaming        │  │
│  │   Protection    │    │   (Rate Limit)  │    │  Service                │  │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────┘  │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ TLS 1.3
┌─────────────────────────▼───────────────────────────────────────────────────┐
│                  PRIVATE ZONE                                              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐  │
│  │ PropDevelopment │    │   Housing       │    │     Мониторинг         │  │
│  │ Core Services   │    │   Domain        │    │     (SIEM/Logs)         │  │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────┘  │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ MQTT/TLS 1.3
┌─────────────────────────▼───────────────────────────────────────────────────┐
│                     IOT ZONE                                               │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐  │
│  │ Интеллектуальный│    │Интеллектуальный │    │    IoT Gateway          │  │
│  │ домофон         │    │шлагбаум         │    │    (MQTT Broker)        │  │
│  │ +Secure Element │    │                 │    │                         │  │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Требования к межсетевому экрану

| Правило | Источник | Назначение | Протокол | Порт | Описание |
|---------|----------|------------|----------|------|----------|
| **ALLOW** | Internet | DMZ | HTTPS/TLS 1.3 | 443 | Доступ к API Gateway |
| **ALLOW** | DMZ | Private | HTTPS/TLS 1.3 | 8443 | API Gateway → Housing Domain |
| **ALLOW** | Private | IoT | MQTT/TLS 1.3 | 8883 | Управление IoT устройствами |
| **ALLOW** | IoT | DMZ | RTSP/TLS | 554 | Видеопотоки домофонов |
| **DENY** | IoT | Private | ALL | ALL | IoT не может инициировать соединения |
| **DENY** | Internet | Private | ALL | ALL | Прямой доступ к внутренним системам |
| **ALLOW** | Private | Internet | HTTPS/TLS 1.3 | 443 | Исходящие соединения для обновлений |

## VI. Мониторинг и аудит

### 6.1 Обязательное журналирование

| Событие | Данные для логирования | Уровень | Хранение |
|---------|------------------------|---------|----------|
| **Биометрическое распознавание** | timestamp, device_id, result (success/fail), user_id | CRITICAL | 3 года |
| **Предоставление доступа** | timestamp, device_id, user_id, access_method | HIGH | 3 года |
| **Видеосессии домофона** | timestamp, device_id, session_id, duration, participants | HIGH | 1 год |
| **Изменение прав доступа** | timestamp, admin_id, user_id, old_rights, new_rights | HIGH | 3 года |
| **API вызовы партнера** | timestamp, endpoint, client_id, response_code, ip | MEDIUM | 1 год |
| **Сбои аутентификации** | timestamp, user_id, failure_reason, ip, device | HIGH | 2 года |
| **Административные действия** | timestamp, admin_id, action, target_user, result | HIGH | 5 лет |

### 6.2 Долгосрочное хранение аудит-логов

```
Архитектура аудита:
┌─────────────────────┐    ETL Pipeline    ┌──────────────────────┐
│  Audit & Monitoring │───────────────────▶│   Data Warehouse     │
│  Service            │                    │                      │
│                     │                    │  - Долгосрочное      │
│ - Реальное время    │                    │    хранение (≥ 90д)  │
│ - Алерты < 1 мин    │                    │  - Сжатие логов      │
│ - Буферизация       │                    │  - Индексирование    │
└─────────────────────┘                    └──────────────────────┘
         │                                           │
         ▼                                           ▼
 ┌──────────────────┐                      ┌─────────────────────┐
 │ SIEM Dashboard   │                      │ Compliance Reports  │
 │ (Реальное время) │                      │ (152-ФЗ, аудит)     │
 └──────────────────┘                      └─────────────────────┘

Retention Policy:
- Critical события: 3+ года в Data Warehouse
- Medium события: 1 год + архивирование
- Сжатие логов через 90 дней
- Индексы для быстрого поиска по ПДн субъектам
```

### 6.3 Алерты безопасности

**Немедленные уведомления (< 1 минуты):**
- Многократные неудачные попытки биометрического доступа
- Попытки доступа в нерабочее время  
- API вызовы с недействительными токенами
- Подозрительная активность (много запросов с одного IP)
- Аномалии в видеостриминге (долгие сессии >5 мин)

**Еженедельные отчеты:**
- Статистика использования системы доступа
- Топ-10 пользователей по количеству входов
- Анализ сбоев и инцидентов безопасности
- Соответствие требованиям 152-ФЗ

## VII. Требования соответствия и compliance

### 7.1 152-ФЗ "О персональных данных"

| Статья | Требование | Техническая реализация |
|--------|------------|----------------------|
| **ч.3** | Письменное согласие на биометрию | Форма согласия в мобильном приложении |
| **11** | Меры по обеспечению безопасности | Шифрование, контроль доступа, аудит |
| **16** | Обработка только с согласия | Проверка согласия перед каждой операцией |
| **18** | Уведомление об обработке | Пользовательское соглашение |

### 7.2 Отраслевые стандарты

| Стандарт | Применимость | Ключевые требования |
|----------|-------------|-------------------|
| **ISO 27001** | Система менеджмента ИБ | Политики безопасности, управление рисками |
| **NIST Cybersecurity Framework** | IoT Security | Идентификация, защита, обнаружение, реагирование |
| **OWASP IoT Top 10** | Безопасность IoT | Аутентификация, шифрование, обновления |

## VIII. План внедрения безопасности

### Этап 1: Подготовка (2-3 недели)
1. Разработка политик безопасности для биометрии
2. Настройка сетевой сегментации
3. Внедрение системы мониторинга

### Этап 2: Интеграция (4-6 недель)  
1. Реализация OAuth 2.0 + mTLS для партнерской интеграции
2. Разработка API для управления доступом
3. Внедрение Video Streaming Service
4. Тестирование безопасности

### Этап 3: Пилотное развертывание (2-4 недели)
1. Установка устройств в тестовой локации
2. Обучение пользователей
3. Мониторинг инцидентов

### Этап 4: Массовое развертывание (8-12 недель)
1. Поэтапное подключение объектов недвижимости
2. Непрерывный мониторинг безопасности
3. Регулярные аудиты соответствия 